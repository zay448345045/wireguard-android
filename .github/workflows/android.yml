name: Build & Release (Manual Trigger)

# 触发条件：手动触发（支持输入版本号）
on:
  workflow_dispatch:
    inputs:
      release_version:
        description: 'Release版本号（例如：v1.0.0）'
        required: true
        default: 'v1.0.0'
        type: string
      is_prerelease:
        description: '是否为预发布版本'
        required: false
        default: false
        type: boolean

# 作业配置
jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 授予发布Release的权限

    steps:
      # 1. 检出代码
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          submodules: recursive  # 递归拉取所有子模块
          token: ${{ secrets.GITHUB_TOKEN }}
      # 2. 配置Java环境
      - name: Set up JDK
        uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      
      # 4. 授予gradle执行权限
      - name: Make gradlew executable
        run: chmod +x ./gradlew

      # 5. 构建Android 14 Release版本APK
      - name: Build  APK
        run: ./gradlew assembleDebug --stacktrace
        #env:
          # 
# 在 Locate Release APK 步骤前新增这个调试步骤
      - name: upload artifact 
        uses: actions/upload-artifact@v6
        with:
         name: apk
         path: '**/*.apk'
         
      - name: Debug - Show build directory structure
        run: |
         echo "=== 打印项目根目录文件 ==="
         ls -la
         echo "=== 打印 build 目录结构 ==="
         ls -la app/build/outputs/ || echo "app/build/outputs 目录不存在"
         # 递归打印所有输出目录，找到所有apk文件
          find . -name "*.apk" 2>/dev/null || echo "未找到任何APK文件"
      # 6. 查找构建好的APK文件
      - name: Locate Release APK
        id: find_apk
        run: |
          # 只查找debug目录的APK
          APK_PATH=$(find app/build/outputs/apk/debug -name "*.apk" | head -n 1)
    
          if [ -z "$APK_PATH" ]; then
          echo "❌ 错误：未在debug目录找到APK文件！"
          echo "当前debug目录结构："
          ls -la app/build/outputs/apk/debug/ 2>/dev/null || echo "debug目录不存在"
          exit 1
          fi
    
          echo "✅ 找到Debug APK：$APK_PATH"
          echo "APK_PATH=$APK_PATH" >> $GITHUB_OUTPUT
          echo "APK_NAME=$(basename $APK_PATH)" >> $GITHUB_OUTPUT
    
          echo "✅ 选中APK文件：$APK_PATH"
          echo "APK_PATH=$APK_PATH" >> $GITHUB_OUTPUT
          echo "APK_NAME=$(basename $APK_PATH)" >> $GITHUB_OUTPUT
          APK_PATH=$(find app/build/outputs/apk/debug -name "*.apk" | head -n 1)
          if [ -z "$APK_PATH" ]; then
            echo "未找到构建的APK文件！"
            exit 1
          fi
          echo "APK_PATH=$APK_PATH" >> $GITHUB_OUTPUT
          echo "APK_NAME=$(basename $APK_PATH)" >> $GITHUB_OUTPUT

      # 7. 发布Release版本（使用手动输入的版本号）
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.find_apk.outputs.APK_PATH }}
          tag_name: ${{ github.event.inputs.release_version }}  # 使用手动输入的版本号作为tag
          name: Release ${{ github.event.inputs.release_version }}
          body: |
            ## Android应用手动发布
            - 发布版本：${{ github.event.inputs.release_version }}
            - 适配系统：Android 14 (API 34)
           # - 构建时间：${{ github.run_at }}
           # - 构建触发方式：手动触发
          draft: false
          prerelease: ${{ github.event.inputs.is_prerelease }}  # 手动选择是否为预发布
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
          
          
          
          
      - name: upload artifact 
        uses: actions/upload-artifact@v6
        with:
         name: apk
         path: '**/*.apk'
