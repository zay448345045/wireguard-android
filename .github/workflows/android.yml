name: Build & Release (Manual Trigger)

# 触发条件：手动触发（支持输入版本号）
on:
  workflow_dispatch:
    inputs:
      release_version:
        description: 'Release版本号（例如：v1.0.0）'
        required: true
        default: 'v1.0.0'
        type: string
      is_prerelease:
        description: '是否为预发布版本'
        required: false
        default: false
        type: boolean

# 作业配置
jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 授予发布Release的权限

    steps:
      # 1. 检出代码
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      # 2. 配置Java环境
      - name: Set up JDK
        uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      
      # 4. 授予gradle执行权限
      - name: Make gradlew executable
        run: chmod +x ./gradlew

      # 5. 构建Android 14 Release版本APK
      - name: Build Release APK
        run: ./gradlew assembleDebug --stacktrace
        #env:
          # 

      # 6. 查找构建好的APK文件
      - name: Locate Release APK
        id: find_apk
        run: |
          APK_PATH=$(find app/build/outputs/apk/debug -name "*.apk" | head -n 1)
          if [ -z "$APK_PATH" ]; then
            echo "未找到构建的APK文件！"
            exit 1
          fi
          echo "APK_PATH=$APK_PATH" >> $GITHUB_OUTPUT
          echo "APK_NAME=$(basename $APK_PATH)" >> $GITHUB_OUTPUT

      # 7. 发布Release版本（使用手动输入的版本号）
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.find_apk.outputs.APK_PATH }}
          tag_name: ${{ github.event.inputs.release_version }}  # 使用手动输入的版本号作为tag
          name: Release ${{ github.event.inputs.release_version }}
          body: |
            ## Android应用手动发布
            - 发布版本：${{ github.event.inputs.release_version }}
            - 适配系统：Android 14 (API 34)
           # - 构建时间：${{ github.run_at }}
           # - 构建触发方式：手动触发
          draft: false
          prerelease: ${{ github.event.inputs.is_prerelease }}  # 手动选择是否为预发布
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
